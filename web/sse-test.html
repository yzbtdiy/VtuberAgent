<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Vutber Agent SSE è°ƒè¯•é¢æ¿</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
        background: #0f172a;
        color: #e2e8f0;
      }

      body {
        margin: 0;
        padding: 0;
      }

      main {
        max-width: 960px;
        margin: 0 auto;
        padding: 24px 16px 48px;
      }

      h1 {
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
      }

      section {
        background: rgba(15, 23, 42, 0.7);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 20px 45px rgba(15, 23, 42, 0.35);
      }

      section h2 {
        margin-top: 0;
        font-size: 1.3rem;
        margin-bottom: 0.75rem;
      }

      label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        background: rgba(30, 41, 59, 0.85);
        color: inherit;
        font-size: 0.95rem;
        box-sizing: border-box;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #38bdf8;
        box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.15);
      }

      textarea {
        min-height: 140px;
        resize: vertical;
        line-height: 1.4;
      }

      .row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }

      .button-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 12px;
      }

      button {
        cursor: pointer;
        border: none;
        border-radius: 999px;
        padding: 10px 18px;
        font-size: 0.95rem;
        font-weight: 600;
        background: linear-gradient(135deg, #38bdf8, #6366f1);
        color: white;
        transition: all 0.3s;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
      }

      button.danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
      }

      button.secondary {
        background: linear-gradient(135deg, #64748b, #475569);
      }

      .template-btn {
        padding: 8px 14px;
        font-size: 0.88rem;
      }

      #status-pill {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.03em;
      }

      #status-pill[data-status="idle"] {
        background: rgba(100, 116, 139, 0.3);
        color: #94a3b8;
      }

      #status-pill[data-status="connecting"] {
        background: rgba(251, 191, 36, 0.3);
        color: #fbbf24;
      }

      #status-pill[data-status="connected"] {
        background: rgba(34, 197, 94, 0.3);
        color: #22c55e;
      }

      #status-pill[data-status="error"] {
        background: rgba(239, 68, 68, 0.3);
        color: #ef4444;
      }

      #log {
        max-height: 500px;
        overflow-y: auto;
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.9);
        padding: 12px;
        font-size: 0.85rem;
        line-height: 1.5;
      }

      .log-entry {
        padding: 8px;
        margin-bottom: 8px;
        border-left: 3px solid #64748b;
        background: rgba(30, 41, 59, 0.5);
        border-radius: 6px;
      }

      .log-entry[data-kind="system"] {
        border-left-color: #6366f1;
      }

      .log-entry[data-kind="inbound"] {
        border-left-color: #22c55e;
      }

      .log-entry[data-kind="outbound"] {
        border-left-color: #f59e0b;
      }

      .log-entry[data-kind="error"] {
        border-left-color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
      }

      .log-entry time {
        color: #94a3b8;
        font-size: 0.8rem;
        margin-right: 8px;
      }

      .log-entry strong {
        color: #e2e8f0;
      }

      .log-entry pre {
        margin: 6px 0 0;
        padding: 8px;
        background: rgba(15, 23, 42, 0.7);
        border-radius: 4px;
        overflow-x: auto;
        font-family: "Cascadia Code", "Fira Code", "Consolas", monospace;
        font-size: 0.8rem;
      }

      .hint {
        font-size: 0.85rem;
        color: #94a3b8;
        margin-top: 6px;
      }
    </style>
  </head>
  <body>
    <main>
      <h1>ğŸ™ï¸ Vutber Agent SSE è°ƒè¯•é¢æ¿</h1>
      <p style="color: #94a3b8; margin-top: -8px">
        Server-Sent Events (SSE) å•å‘æµ + POST å‘½ä»¤æäº¤
      </p>

      <section>
        <h2>âš™ï¸ è¿æ¥é…ç½®</h2>
        <div class="row">
          <div>
            <label for="endpoint-input">æœåŠ¡ç«¯ç‚¹</label>
            <input
              id="endpoint-input"
              type="text"
              value="http://127.0.0.1:9000"
              placeholder="http://127.0.0.1:9000"
            />
            <p class="hint">SSE äº‹ä»¶æµï¼šGET /eventsï¼Œå‘½ä»¤æäº¤ï¼šPOST /command</p>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="accesskey-input">Access Key</label>
            <input
              id="accesskey-input"
              type="text"
              placeholder="é…ç½®æ–‡ä»¶ä¸­çš„ ws.access_key"
            />
          </div>
          <div>
            <label for="secretkey-input">Secret Key</label>
            <input
              id="secretkey-input"
              type="password"
              placeholder="é…ç½®æ–‡ä»¶ä¸­çš„ ws.secret_key"
            />
          </div>
        </div>
        <p class="hint">
          ç­¾åå‚æ•°ï¼ˆaccess_keyã€timestampã€nonceã€signatureï¼‰é€šè¿‡æŸ¥è¯¢å‚æ•°é™„åŠ 
        </p>
        <div class="button-row">
          <button id="connect-btn">ğŸ”— è¿æ¥äº‹ä»¶æµ</button>
          <button id="disconnect-btn" class="danger" disabled>ğŸ”Œ æ–­å¼€</button>
          <button id="clear-log-btn" class="secondary">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>
        <p style="margin-top: 12px">
          è¿æ¥çŠ¶æ€: <span id="status-pill" data-status="idle">æœªè¿æ¥</span>
        </p>
      </section>

      <section>
        <h2>ğŸ“¤ å‘é€å‘½ä»¤</h2>
        <label for="payload-textarea">æ¶ˆæ¯ä½“ (JSON)</label>
        <textarea id="payload-textarea" placeholder='{"action":"command","input":"å†™ä¸€æ®µæ—…è¡Œ vlog è„šæœ¬"}'></textarea>
        <div class="button-row">
          <button class="template-btn" data-template="command">ğŸ’¬ å¯¹è¯ç¤ºä¾‹</button>
          <button class="template-btn" data-template="live-start">ğŸ“¡ å¯åŠ¨ç›´æ’­</button>
          <button class="template-btn" data-template="live-stop">â¹ï¸ åœæ­¢ç›´æ’­</button>
          <button class="template-btn" data-template="live-status">ğŸ“Š ç›´æ’­çŠ¶æ€</button>
        </div>
        <div class="button-row" style="margin-top: 16px">
          <button id="send-btn" disabled>ğŸš€ å‘é€å‘½ä»¤</button>
        </div>
      </section>

      <section>
        <h2>ğŸ“‹ äº‹ä»¶æ—¥å¿—</h2>
        <div id="log"></div>
      </section>
    </main>

    <script>
      const endpointInput = document.getElementById("endpoint-input");
      const accessKeyInput = document.getElementById("accesskey-input");
      const secretKeyInput = document.getElementById("secretkey-input");
      const connectBtn = document.getElementById("connect-btn");
      const disconnectBtn = document.getElementById("disconnect-btn");
      const clearLogBtn = document.getElementById("clear-log-btn");
      const statusPill = document.getElementById("status-pill");
      const payloadTextarea = document.getElementById("payload-textarea");
      const sendBtn = document.getElementById("send-btn");
      const logContainer = document.getElementById("log");
      const templateButtons = document.querySelectorAll(".template-btn");

      let eventSource = null;
      let currentAuthParams = null;

      function appendLog(kind, title, details) {
        const entry = document.createElement("div");
        entry.className = "log-entry";
        entry.dataset.kind = kind;

        const timestamp = document.createElement("time");
        timestamp.textContent = new Date().toLocaleTimeString();
        entry.appendChild(timestamp);

        const heading = document.createElement("strong");
        heading.textContent = title;
        entry.appendChild(heading);

        if (details !== undefined) {
          const pre = document.createElement("pre");
          if (typeof details === "string") {
            pre.textContent = details;
          } else {
            pre.textContent = JSON.stringify(details, null, 2);
          }
          entry.appendChild(pre);
        }

        logContainer.appendChild(entry);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      function updateStatus(status, message) {
        statusPill.dataset.status = status;
        statusPill.textContent = message;
      }

      function normaliseEndpoint(rawUrl) {
        let value = (rawUrl || "").trim();
        if (!value) {
          value = "http://127.0.0.1:9000";
        }
        if (!/^https?:\/\//i.test(value)) {
          value = `http://${value}`;
        }
        try {
          return new URL(value);
        } catch (err) {
          throw new Error("æ— æ³•è§£ææœåŠ¡åœ°å€ï¼Œè¯·æ£€æŸ¥è¾“å…¥ã€‚" + (err?.message ? `\n${err.message}` : ""));
        }
      }

      function generateNonce() {
        const bytes = new Uint8Array(16);
        window.crypto.getRandomValues(bytes);
        return Array.from(bytes, (byte) => byte.toString(16).padStart(2, "0")).join("");
      }

      function bufferToHex(buffer) {
        const bytes = new Uint8Array(buffer);
        return Array.from(bytes, (byte) => byte.toString(16).padStart(2, "0")).join("");
      }

      async function buildAuthParams() {
        if (!window.crypto || !window.crypto.subtle) {
          throw new Error("å½“å‰æµè§ˆå™¨ç¯å¢ƒä¸æ”¯æŒ Web Crypto HMACï¼Œè¯·åœ¨ HTTPS ç¯å¢ƒæˆ– localhost ä¸­è°ƒè¯•ã€‚");
        }

        const accessKey = accessKeyInput.value.trim();
        const secretKey = secretKeyInput.value.trim();

        if (!accessKey) {
          throw new Error("è¯·å…ˆè¾“å…¥ Access Keyï¼ˆé…ç½®æ–‡ä»¶ä¸­çš„ ws.access_keyï¼‰ã€‚");
        }
        if (!secretKey) {
          throw new Error("è¯·å…ˆè¾“å…¥ Secret Keyï¼ˆé…ç½®æ–‡ä»¶ä¸­çš„ ws.secret_keyï¼‰ã€‚");
        }

        const timestamp = Math.floor(Date.now() / 1000).toString();
        const nonce = generateNonce();
        const canonical = `${accessKey}:${timestamp}:${nonce}`;

        const encoder = new TextEncoder();
        const key = await window.crypto.subtle.importKey(
          "raw",
          encoder.encode(secretKey),
          {
            name: "HMAC",
            hash: "SHA-256",
          },
          false,
          ["sign"]
        );
        const signatureBuffer = await window.crypto.subtle.sign(
          "HMAC",
          key,
          encoder.encode(canonical)
        );
        const signature = bufferToHex(signatureBuffer);

        return {
          access_key: accessKey,
          timestamp: timestamp,
          nonce: nonce,
          signature: signature,
        };
      }

      function setConnectedState(connected) {
        connectBtn.disabled = connected;
        disconnectBtn.disabled = !connected;
        sendBtn.disabled = !connected;
      }

      connectBtn.addEventListener("click", async () => {
        if (eventSource) {
          appendLog("system", "å·²ç»è¿æ¥", "æ— éœ€é‡å¤è¿æ¥ã€‚");
          return;
        }

        let authParams;
        try {
          authParams = await buildAuthParams();
        } catch (error) {
          appendLog(
            "error",
            "ç”Ÿæˆç­¾åå¤±è´¥",
            error instanceof Error ? error.message : String(error)
          );
          updateStatus("error", "ç”Ÿæˆç­¾åå¤±è´¥");
          return;
        }

        currentAuthParams = authParams;

        const baseUrl = normaliseEndpoint(endpointInput.value);
        const eventsUrl = new URL("/events", baseUrl);
        eventsUrl.searchParams.set("access_key", authParams.access_key);
        eventsUrl.searchParams.set("timestamp", authParams.timestamp);
        eventsUrl.searchParams.set("nonce", authParams.nonce);
        eventsUrl.searchParams.set("signature", authParams.signature);

        appendLog("system", "å¼€å§‹è¿æ¥ SSE", eventsUrl.toString());
        updateStatus("connecting", "è¿æ¥ä¸­...");
        connectBtn.disabled = true;
        disconnectBtn.disabled = true;
        sendBtn.disabled = true;

        eventSource = new EventSource(eventsUrl.toString());

        eventSource.addEventListener("open", () => {
          appendLog("system", "è¿æ¥æˆåŠŸ", `å·²è¿æ¥åˆ° ${eventsUrl.origin}`);
          updateStatus("connected", "å·²è¿æ¥");
          setConnectedState(true);
        });

        eventSource.addEventListener("message", (event) => {
          let payload = event.data;
          try {
            payload = JSON.parse(event.data);
          } catch (_) {
            // ä¿ç•™åŸå§‹å­—ç¬¦ä¸²
          }
          appendLog("inbound", "æ”¶åˆ°äº‹ä»¶", payload);
        });

        eventSource.addEventListener("error", (event) => {
          console.error("SSE error", event);
          appendLog(
            "error",
            "è¿æ¥å¼‚å¸¸",
            "è¯·æ£€æŸ¥åœ°å€ / Access Key / Secret Key / æœåŠ¡å™¨çŠ¶æ€ã€‚"
          );
          updateStatus("error", "è¿æ¥å¼‚å¸¸");
          setConnectedState(false);
          if (eventSource) {
            eventSource.close();
            eventSource = null;
          }
        });
      });

      disconnectBtn.addEventListener("click", () => {
        if (!eventSource) {
          appendLog("system", "å°šæœªè¿æ¥", "æ— éœ€æ–­å¼€ã€‚");
          return;
        }
        appendLog("system", "ä¸»åŠ¨æ–­å¼€", "ç”¨æˆ·è¯·æ±‚å…³é—­è¿æ¥");
        eventSource.close();
        eventSource = null;
        currentAuthParams = null;
        updateStatus("idle", "æœªè¿æ¥");
        setConnectedState(false);
      });

      clearLogBtn.addEventListener("click", () => {
        logContainer.innerHTML = "";
      });

      sendBtn.addEventListener("click", async () => {
        if (!currentAuthParams) {
          appendLog("system", "å°šæœªè¿æ¥", "è¯·å…ˆå»ºç«‹ SSE è¿æ¥");
          return;
        }
        let payloadText = payloadTextarea.value.trim();
        if (!payloadText) {
          appendLog("system", "æ— æ•ˆè¾“å…¥", "æ¶ˆæ¯ä½“ä¸èƒ½ä¸ºç©º");
          return;
        }
        let parsedPayload;
        try {
          parsedPayload = JSON.parse(payloadText);
        } catch (err) {
          appendLog(
            "error",
            "JSON è§£æå¤±è´¥",
            `è¯·æ£€æŸ¥æ¶ˆæ¯ä½“æ ¼å¼æ˜¯å¦æ­£ç¡®: ${err.message}`
          );
          return;
        }

        const baseUrl = normaliseEndpoint(endpointInput.value);
        const commandUrl = new URL("/command", baseUrl);
        commandUrl.searchParams.set("access_key", currentAuthParams.access_key);
        commandUrl.searchParams.set("timestamp", currentAuthParams.timestamp);
        commandUrl.searchParams.set("nonce", currentAuthParams.nonce);
        commandUrl.searchParams.set("signature", currentAuthParams.signature);

        try {
          const response = await fetch(commandUrl.toString(), {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: payloadText,
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const result = await response.json();
          appendLog("outbound", "å‘é€å‘½ä»¤æˆåŠŸ", { request: parsedPayload, response: result });
        } catch (err) {
          appendLog(
            "error",
            "å‘é€å‘½ä»¤å¤±è´¥",
            err instanceof Error ? err.message : String(err)
          );
        }
      });

      templateButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const type = btn.dataset.template;
          switch (type) {
            case "command":
              payloadTextarea.value = JSON.stringify(
                {
                  action: "command",
                  input: "å†™ä¸€æ®µæ—…è¡Œ vlog è„šæœ¬",
                },
                null,
                2
              );
              break;
            case "live-start":
              payloadTextarea.value = JSON.stringify(
                {
                  action: "live_start",
                },
                null,
                2
              );
              break;
            case "live-stop":
              payloadTextarea.value = JSON.stringify(
                {
                  action: "live_stop",
                },
                null,
                2
              );
              break;
            case "live-status":
              payloadTextarea.value = JSON.stringify(
                {
                  action: "live_status",
                },
                null,
                2
              );
              break;
            default:
              break;
          }
        });
      });

      setConnectedState(false);
      updateStatus("idle", "æœªè¿æ¥");
    </script>
  </body>
</html>
